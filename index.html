<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Home + KI + Kalender + Blumenstrau√ü</title>
  <link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#9d9dc1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    * { box-sizing: border-box; }

    /* ===== Theme (CSS-Variablen) ===== */
    :root{
      --page-bg: #e9ebbf;
      --app-bg: #9d9dc1;

      --card-bg: #ffffff;
      --card-bg-soft: #ffffffcc;
      --card-bg-tint: #ffffff90;

      --text: #555;
      --text-strong: #444;
      --text-soft: #777;
      --text-muted: #999;

      --shadow: 0 4px 12px rgba(0,0,0,0.06);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.04);

      --btn-primary: #88b04b;
      --btn-secondary: #e0e0e0;

      --nav-bg: #bfbfbf;

      --border: #ddd;
      --border-soft: #e0e0e0;

      --focus: #88b04b;

      /* Kalender-Farben */
      --cal-rot:  #ffcccc;
      --cal-gelb: #fff3b0;
      --cal-blau: #cce4ff;
    }

    body.dark{
      --page-bg: #14161a;
      --app-bg: #222637;

      --card-bg: #1c2030;
      --card-bg-soft: rgba(28,32,48,0.85);
      --card-bg-tint: rgba(28,32,48,0.65);

      --text: #e7e7ea;
      --text-strong: #ffffff;
      --text-soft: #c7c7cf;
      --text-muted: #9aa0aa;

      --shadow: 0 6px 18px rgba(0,0,0,0.35);
      --shadow-soft: 0 3px 10px rgba(0,0,0,0.35);

      --btn-primary: #88b04b;
      --btn-secondary: #2a2f45;

      --nav-bg: #2a2f45;

      --border: #3a4060;
      --border-soft: #2f3553;

      --focus: #a9d65a;

      --cal-rot:  rgba(255, 120, 120, 0.35);
      --cal-gelb: rgba(255, 221, 120, 0.35);
      --cal-blau: rgba(120, 180, 255, 0.35);
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #9d9dc1; /* gleiche Farbe wie .app */
  overflow: hidden;
}


    .app {
  position: relative;
  width: 100%;
  max-width: 100%;   /* statt 600px */
  height: 100vh;
  background: var(--app-bg);
  display: flex;
  flex-direction: column;
  transition: background 0.2s ease;
  overflow: hidden;
}

    /* Screens */
    .screen {
      flex: 1;
      padding: 16px;
      padding-bottom: calc(66px + env(safe-area-inset-bottom)+16px);
      overflow-y: auto;
      display: none;

      /* Fix f√ºr dein Problem:
         Inhalt wird beim Scrollen unten "abgeschnitten" und kann nicht in die Bottom-Bar hineinmalen. */
      overscroll-behavior: contain;
      overflow-x: hidden;
      position: relative;
      z-index: 1;
    }
    .screen-active { display: block; }

    .title {
      font-weight: 800;
      font-size: 1.5rem;
      margin-bottom: 12px;
      color: var(--text-strong);
      letter-spacing: -0.2px;
    }

    .home-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: var(--shadow);
      margin-bottom: 18px;
    }

    .todo-title {
      font-weight: 800;
      font-size: 0.95rem;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .todo-empty {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .todo-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .todo-checkbox {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 2px solid #aaa;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: #fff;
      cursor: pointer;
      flex-shrink: 0;
    }

    .todo-checked {
      background: var(--btn-primary);
      border-color: var(--btn-primary);
      color: #fff;
    }

    .todo-text {
      color: var(--text);
      flex: 1;
    }

    .todo-done {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: var(--shadow);
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-text { flex: 1; }

    .card-title {
      font-weight: 800;
      font-size: 0.95rem;
      margin-bottom: 6px;
      color: var(--text-strong);
    }

    .card-text p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text);
      line-height: 1.4;
    }

    .bot {
      width: 70px;
      height: 70px;
      border-radius: 16px;
      background: var(--page-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      border: 1px solid rgba(0,0,0,0.06);
    }
    body.dark .bot{
      border-color: rgba(255,255,255,0.07);
    }

    .input-label {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .input-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .input-area {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 8px;
      min-height: 80px;
      max-height: 180px;
      resize: vertical;
      font-size: 0.9rem;
      margin-bottom: 8px;
      background: var(--card-bg);
      color: var(--text);
      outline: none;
    }
    .input-area:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 2px rgba(136,176,75,0.18);
    }

    .button-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 10px;
    }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      background: var(--btn-primary);
      color: #fff;
      cursor: pointer;
      font-weight: 700;
    }

    .btn-secondary {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      background: var(--btn-secondary);
      color: var(--text-strong);
      cursor: pointer;
      font-weight: 700;
    }

    .output {
      font-size: 0.85rem;
      color: var(--text);
      background: var(--card-bg);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: var(--shadow-soft);
      min-height: 40px;
      white-space: pre-line;
      border: 1px solid rgba(0,0,0,0.04);
    }
    body.dark .output{ border-color: rgba(255,255,255,0.06); }

    .year-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 12px;
      font-weight: 800;
      font-size: 1.3rem;
      color: var(--text-strong);
    }

    .months-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
    }

    .month {
      background: var(--card-bg-tint);
      border-radius: 12px;
      padding: 10px;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      border: 1px solid rgba(0,0,0,0.04);
    }
    body.dark .month{ border-color: rgba(255,255,255,0.06); }

    .month:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      cursor: pointer;
    }

    .month-name {
      text-align: center;
      font-weight: 800;
      font-size: 0.95rem;
      margin-bottom: 6px;
      color: var(--text-strong);
    }

    .month-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      color: var(--text);
    }

    .month-table th {
      text-align: center;
      font-weight: 700;
      padding: 4px 0;
      color: var(--text-soft);
    }

    .month-table td {
      text-align: center;
      padding: 4px 0;
      height: 24px;
      cursor: pointer;
      border-radius: 8px;
    }

    .month-table td.empty {
      color: transparent;
      cursor: default;
    }

    #weekView { display: none; }

    .week-header {
      background: var(--card-bg-tint);
      border-radius: 12px;
      padding: 8px 10px;
      margin-top: 6px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid rgba(0,0,0,0.04);
    }
    body.dark .week-header{ border-color: rgba(255,255,255,0.06); }

    .week-title {
      font-size: 0.9rem;
      font-weight: 800;
      text-align: center;
      flex: 1;
      color: var(--text-strong);
    }

    .btn, .btn-icon {
      border: none;
      background: var(--card-bg);
      color: var(--text-strong);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 800;
      border: 1px solid rgba(0,0,0,0.05);
    }
    body.dark .btn, body.dark .btn-icon{ border-color: rgba(255,255,255,0.06); }

    .btn-icon {
      width: 30px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .week-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      background: var(--card-bg-tint);
      border-radius: 12px;
      overflow: hidden; /* wichtig: Tabelleninhalt wird im Table-Container geclippt */
      border: 1px solid rgba(0,0,0,0.04);
    }
    body.dark .week-table{ border-color: rgba(255,255,255,0.06); }

    .week-table thead th {
      border-bottom: 1px solid var(--border-soft);
      padding: 6px 4px;
      text-align: center;
      font-weight: 800;
      background: var(--card-bg);
      color: var(--text-strong);
    }

    .week-table tbody td,
    .week-table tbody th {
      border-bottom: 1px solid rgba(0,0,0,0.06);
      border-right: 1px solid rgba(0,0,0,0.04);
      padding: 3px 4px;
      height: 24px;
      text-align: center;
      font-weight: 500;
      color: var(--text);
      transition: background 0.15s ease;
    }
    body.dark .week-table tbody td,
    body.dark .week-table tbody th{
      border-bottom-color: rgba(255,255,255,0.06);
      border-right-color: rgba(255,255,255,0.05);
    }

    .week-table tbody th {
      width: 52px;
      font-weight: 800;
      background: rgba(0,0,0,0.03);
      position: sticky;
      left: 0;
      z-index: 1;
      color: var(--text-strong);
    }
    body.dark .week-table tbody th{
      background: rgba(255,255,255,0.04);
    }

    .day-header-small {
      font-size: 0.85rem;
      font-weight: 900;
      display: block;
    }

    .day-header-date {
      display: block;
      font-size: 0.7rem;
      color: var(--text-muted);
      font-weight: 700;
    }

    .editor-panel {
      margin-top: 10px;
      background: var(--card-bg-soft);
      border-radius: 12px;
      padding: 10px 10px;
      display: none;
      flex-direction: column;
      gap: 8px;
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(6px);
    }
    body.dark .editor-panel{ border-color: rgba(255,255,255,0.06); }

    .editor-title {
      font-size: 0.85rem;
      font-weight: 900;
      color: var(--text-strong);
    }

    .editor-text {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px;
      font-size: 0.85rem;
      resize: vertical;
      min-height: 44px;
      max-height: 140px;
      background: var(--card-bg);
      color: var(--text);
      outline: none;
    }
    .editor-text:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 2px rgba(136,176,75,0.18);
    }

    .editor-buttons {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .editor-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 800;
    }

    .editor-save { background: var(--btn-primary); color: #fff; }
    .editor-delete { background: #e57373; color: #fff; }
    body.dark .editor-delete{ background: #d85f5f; }
    .editor-cancel { background: var(--btn-secondary); color: var(--text-strong); }

    .editor-colors {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
      margin-bottom: 0;
      font-size: 0.85rem;
    }

    .editor-colors-label {
      font-weight: 900;
      color: var(--text-strong);
    }

    .color-dot {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid transparent;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .color-rot   { background: var(--cal-rot); }
    .color-gelb  { background: var(--cal-gelb); }
    .color-blau  { background: var(--cal-blau); }

    .color-active {
      border-color: var(--text-strong);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
    }

    .editor-legend {
      font-size: 0.78rem;
      color: var(--text);
      margin: 0;
    }
    .editor-legend span {
      margin-right: 10px;
      white-space: nowrap;
      font-weight: 700;
    }

    .analyse-card-title {
      font-weight: 900;
      margin-bottom: 6px;
      color: var(--text-strong);
    }

    .plant-wrapper {
      margin-top: 18px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      height: 360px;
    }

    .plant-svg {
      width: 300px;
      height: 360px;
    }

    /* ===== Einstellungen ===== */
    .settings-card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 12px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.04);
    }
    body.dark .settings-card{ border-color: rgba(255,255,255,0.06); }

    .settings-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .settings-rowbtn {
      width: 100%;
      border: none;
      background: rgba(0,0,0,0.04);
      color: var(--text-strong);
      border-radius: 14px;
      padding: 12px 12px;
      text-align: left;
      cursor: pointer;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    body.dark .settings-rowbtn{
      background: rgba(255,255,255,0.05);
    }

    .settings-subtitle {
      font-weight: 900;
      color: var(--text-strong);
      margin: 4px 0 2px;
    }

    .settings-muted {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin: 0;
      line-height: 1.35;
      font-weight: 650;
    }

    .settings-divider {
      height: 1px;
      background: rgba(0,0,0,0.06);
      margin: 4px 0;
    }
    body.dark .settings-divider{ background: rgba(255,255,255,0.08); }

    .profile-row {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 12px;
      border-radius: 16px;
      background: rgba(0,0,0,0.03);
    }
    body.dark .profile-row{
      background: rgba(255,255,255,0.05);
    }

    .profile-left { flex: 1; }

    .avatar {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      background: rgba(233,235,191,0.9);
      border: 2px solid rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }
    body.dark .avatar{
      background: rgba(233,235,191,0.15);
      border-color: rgba(255,255,255,0.10);
    }
    .avatar img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .settings-input {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      padding: 10px 10px;
      font-size: 0.95rem;
      color: var(--text);
      outline: none;
      margin-top: 8px;
    }
    .settings-input:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 2px rgba(136,176,75,0.18);
    }

    .settings-upload {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      font-weight: 900;
      color: var(--text-strong);
      cursor: pointer;
      user-select: none;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 16px;
      background: rgba(0,0,0,0.03);
    }
    body.dark .toggle-row{
      background: rgba(255,255,255,0.05);
    }

    .toggle-label {
      font-weight: 900;
      color: var(--text-strong);
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
      background: rgba(0,0,0,0.18);
      border-radius: 999px;
      cursor: pointer;
      border: 1px solid rgba(0,0,0,0.08);
      flex-shrink: 0;
    }
    body.dark .toggle-switch{
      background: rgba(255,255,255,0.15);
      border-color: rgba(255,255,255,0.08);
    }

    .toggle-knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #fff;
      transition: transform 0.18s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }
    .toggle-on{
      background: rgba(136,176,75,0.55);
      border-color: rgba(136,176,75,0.45);
    }
    .toggle-on .toggle-knob{
      transform: translateX(22px);
    }

    .settings-danger-btn {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 0.95rem;
      background: #e57373;
      color: #fff;
      cursor: pointer;
      font-weight: 900;
      width: 100%;
      margin-top: 6px;
    }
    body.dark .settings-danger-btn{ background: #d85f5f; }

    /* Simple Modal */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
    }
    .modal{
      width: min(560px, 100%);
      background: var(--card-bg);
      color: var(--text);
      border-radius: 18px;
      padding: 14px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(0,0,0,0.06);
    }
    body.dark .modal{ border-color: rgba(255,255,255,0.08); }
    .modal h3{
      margin: 0 0 8px;
      color: var(--text-strong);
      font-weight: 1000;
      font-size: 1.1rem;
    }
    .modal p{
      margin: 0 0 12px;
      color: var(--text);
      font-weight: 650;
      line-height: 1.4;
      font-size: 0.95rem;
    }
    .modal-actions{
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

   .bottom-nav{
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 0;
  width: 100%;
  max-width: 600px;

  height: 66px;              /* etwas h√∂her f√ºrs Handy */
  background: #bfbfbf;
  display: flex;
  justify-content: space-around;
  align-items: center;

  border-radius: 16px 16px 0 0;
  z-index: 9999;             /* immer √ºber allem */
  padding-bottom: env(safe-area-inset-bottom); /* iPhone Home-Bar */
}

    body.dark .bottom-nav{
      border-top-color: rgba(255,255,255,0.08);
    }

    .nav-item {
      font-size: 1.4rem;
      opacity: 0.65;
      cursor: pointer;
      user-select: none;
    }

    .nav-active {
      opacity: 1;
      filter: drop-shadow(0 0 2px rgba(233,235,191,0.35));
      transform: translateY(-1px);
    }

    /* Home Greeting */
    .home-greeting {
      font-size: 1rem;
      color: var(--text);
      margin-top: -4px;
      margin-bottom: 14px;
      font-weight: 750;
    }
    .home-greeting-strong{
      font-size: 1rem;
      font-weight: 900;
      color: var(--text-strong);
      margin-bottom: 10px;
    }
    /* =========================
   MOBILE OPTIMIERUNG
   ========================= */
@media (max-width: 600px) {

  /* Bottom Navigation Icons */
  .bottom-nav {
    height: 72px; /* h√∂her f√ºr Finger */
  }

  .nav-item {
    font-size: 2.1rem;   /* vorher ~1.4rem */
    opacity: 0.8;
  }

  /* Aktives Icon noch etwas gr√∂√üer */
  .nav-active {
    font-size: 2.3rem;
  }

  /* Buttons allgemein */
  .btn,
  .btn-primary,
  .btn-secondary {
    font-size: 1rem;
    padding: 10px 16px;
  }

  /* Titel */
  .title {
    font-size: 1.6rem;
  }

  /* Karten-Text */
  .home-card,
  .card {
    font-size: 1rem;
  }
}
/* iOS PWA: Eingabe-Felder m√ºssen Fokus bekommen */
input, textarea, [contenteditable="true"] {
  -webkit-user-select: text;
  user-select: text;
  -webkit-touch-callout: default;
  touch-action: manipulation;
}


  </style>
</head>
<body>

<div class="app">
  <!-- HOME -->
  <div class="screen screen-active" id="screenHome">
    <div class="title">Home</div>

    <p class="home-greeting" id="homeGreetingLine">
      Hallo, ich bin dein Planer üòä
    </p>

    <div class="home-card">
      <div class="home-greeting home-greeting-strong" id="homeWelcomeLine">
        Willkommen zur√ºck! Lass uns deine Aufgaben f√ºr heute organisieren.
      </div>

      <div class="todo-title">To Do:</div>
      <div id="todoListOpen"></div>

      <div class="todo-title" style="margin-top: 12px;">Erledigt:</div>
      <div id="todoListDone"></div>
    </div>
  </div>

  <!-- KI -->
  <div class="screen" id="screenKI">
    <div class="title">KI</div>

    <div class="card">
      <div class="card-text">
        <div class="card-title">Was hast du diese Woche geplant?</div>
        <p>
Schreibe bitte:
1. den Wochentag,
2. das Datum (z. B. Mo 12.02.),
3. die Aufgabe und
4. ggf. eine Uhrzeit.</p>
      </div>
      <div class="bot">ü§ñ</div>
    </div>

    <div class="input-label">Deine Planung</div>
    <div class="input-hint">
      Beispiel pro Zeile: ‚ÄûMontag 12.02. Mathe lernen 16:00‚Äú
    </div>
    <textarea id="planInput" class="input-area"
      placeholder="Montag 12.02. Mathe lernen 16:00&#10;Mittwoch 14.02. Fu√üballtraining 18:30"></textarea>

    <div class="button-row">
      <button class="btn-secondary" id="clearInput">Leeren</button>
      <button class="btn-primary" id="sendPlan">An KI senden</button>
    </div>

    <div class="output" id="outputBox">
      Schreibe deine Planung oben hinein ‚Äì ich trage sie in den Kalender und in deine To-Do-Liste ein.
    </div>
  </div>

  <!-- KALENDER -->
  <div class="screen" id="screenCalendar">
    <div class="title">Kalender</div>

    <div id="yearView">
      <div class="year-header" id="yearTitle"></div>
      <div class="months-grid" id="calendar"></div>
    </div>

    <div id="weekView">
      <div class="week-header">
        <button class="btn" id="backToYear">‚Üê Jahr</button>
        <div class="week-title" id="weekTitle"></div>
        <div>
          <button class="btn-icon" id="prevWeek">‚Äπ</button>
          <button class="btn-icon" id="nextWeek">‚Ä∫</button>
        </div>
      </div>

      <table class="week-table">
        <thead>
          <tr>
            <th>üïí</th>
            <th>Ma</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th><th>Sa</th><th>So</th>
          </tr>
        </thead>
        <tbody id="weekBody"></tbody>
      </table>

      <div class="editor-panel" id="editorPanel">
        <div class="editor-title" id="editorInfo">Kein Slot ausgew√§hlt</div>
        <textarea id="editorText" class="editor-text" placeholder="Notiz f√ºr diesen Zeitpunkt..."></textarea>

        <div class="editor-colors">
          <span class="editor-colors-label">Farbe:</span>
          <button type="button" class="color-dot color-rot"   data-color="rot"  title="Wichtig (Rot)"></button>
          <button type="button" class="color-dot color-gelb"  data-color="gelb" title="Arbeiten (Gelb)"></button>
          <button type="button" class="color-dot color-blau"  data-color="blau" title="Freizeit (Blau)"></button>
        </div>
        <p class="editor-legend">
          <span>üî¥ Rot = Wichtig</span>
          <span>üü° Gelb = Arbeiten</span>
          <span>üîµ Blau = Freizeit</span>
        </p>

        <div class="editor-buttons">
          <button class="editor-btn editor-save" id="saveEntry">Speichern</button>
          <button class="editor-btn editor-delete" id="deleteEntry">L√∂schen</button>
          <button class="editor-btn editor-cancel" id="cancelEdit">Abbrechen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ANALYSE / BLUMENSTRAUSS -->
  <div class="screen" id="screenPlant">
    <div class="title">Analyse</div>

    <div class="home-card">
      <div class="analyse-card-title">WOW!</div>
      <p>Du hast diese Woche schon <span id="progressPercent">0</span>% deiner Aufgaben bearbeitet.</p>
      <p>Mach weiter, damit dein Blumenstrau√ü w√§chst!</p>
    </div>

    <div class="plant-wrapper">
      <svg
        id="plantSvg"
        class="plant-svg"
        viewBox="0 0 200 220"
        xmlns="http://www.w3.org/2000/svg"
      >
        <defs>
          <style>
            .bouquet-stem {
              fill: none;
              stroke: #4c8b4a;
              stroke-width: 4.5;
              stroke-linecap: round;
              stroke-linejoin: round;
            }
            .flower { opacity: 0; transition: opacity 0.35s ease; }
            .flower-petal { fill: #ffb7d5; stroke: #c7668a; stroke-width: 1.5; }
            .flower-center { fill: #ffd966; stroke: #d1a52f; stroke-width: 1; }

            .pot-body { fill: #b8d8f5; stroke: #7a9bb8; stroke-width: 3; stroke-linejoin: round; }
            .pot-rim  { fill: #c9e0fa; stroke: #7a9bb8; stroke-width: 3; stroke-linejoin: round; }
            .pot-shadow { fill: rgba(0, 0, 0, 0.08); }

            .percent-label {
              font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
              font-size: 18px;
              font-weight: 800;
              fill: #fdf9f3;
              text-anchor: middle;
              dominant-baseline: middle;
            }
          </style>
        </defs>

        <ellipse class="pot-shadow" cx="100" cy="205" rx="56" ry="9" />
        <rect class="pot-rim" x="40" y="128" width="120" height="24" rx="12" ry="12" />
        <path class="pot-body" d="M58 152 H142 L132 200 H68 Z" />
        <text id="plantPercentLabel" class="percent-label" x="100" y="178">0%</text>

        <path class="bouquet-stem" d="M100 152 C 100 135, 100 120, 100 104 C 100 92, 100 82, 100 70" />

        <!-- 12 Bl√ºten -->
        <g class="flower" transform="translate(100,60)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(118,58)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(82,58)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(128,72)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(72,72)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(100,80)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(124,86)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(76,86)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(100,45)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(136,64)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(64,64)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(124,96)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
        <g class="flower" transform="translate(76,96)">
          <circle class="flower-center" cx="0" cy="0" r="4.3" />
          <circle class="flower-petal" cx="0" cy="-9" r="4.5" />
          <circle class="flower-petal" cx="0" cy="9" r="4.5" />
          <circle class="flower-petal" cx="-9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="9" cy="0" r="4.5" />
          <circle class="flower-petal" cx="6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="6.5" cy="6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="-6.5" r="4.2" />
          <circle class="flower-petal" cx="-6.5" cy="6.5" r="4.2" />
        </g>
      </svg>
    </div>
  </div>

  <!-- EINSTELLUNGEN -->
  <div class="screen" id="screenSettings">
    <div class="title">Einstellungen</div>

    <div class="settings-card">
      <div class="settings-list">
        <button class="settings-rowbtn" id="btnPrivacy">
          Datenschutzbestimmung
          <span style="opacity:.7;">‚Ä∫</span>
        </button>

        <div class="profile-row">
          <div class="profile-left">
            <div class="settings-subtitle">Profil bearbeiten</div>
            <p class="settings-muted">Passe deinen Namen an oder lade ein Profilbild hoch.</p>

            <label class="settings-upload" for="profileImageInput">
              Profilbild hier hochladen
              <span style="opacity:.7;">üì∑</span>
            </label>
            <input id="profileImageInput" type="file" accept="image/*" style="display:none;" />

            <div style="margin-top: 10px; font-weight: 900; color: var(--text-strong);">Name:</div>
            <input id="profileNameInput" class="settings-input" placeholder="Name" />
            <p class="settings-muted" style="margin-top:8px;">
              Tipp: Wenn du einen Namen setzt, wird er auf der Home-Seite in der Begr√º√üung angezeigt.
            </p>
          </div>

          <div class="avatar" id="profileAvatar" title="Profilbild">
            <span style="font-weight: 1000; color: var(--text-strong);">üôÇ</span>
          </div>
        </div>

        <div class="toggle-row">
          <div>
            <div class="toggle-label">Dark-Mode</div>
            <p class="settings-muted" style="margin-top:4px;">Schaltet die App in ein dunkles Design.</p>
          </div>
          <div class="toggle-switch" id="darkToggle" role="switch" aria-checked="false" tabindex="0">
            <div class="toggle-knob"></div>
          </div>
        </div>

        <div class="settings-divider"></div>

        <div class="toggle-row">
          <div>
            <div class="toggle-label">Begr√º√üung auf Home</div>
            <p class="settings-muted" style="margin-top:4px;">Zeigt/verbirgt den Begr√º√üungstext √ºber der To-Do-Liste.</p>
          </div>
          <div class="toggle-switch" id="greetingToggle" role="switch" aria-checked="true" tabindex="0">
            <div class="toggle-knob"></div>
          </div>
        </div>

        <div class="settings-divider"></div>

        <div>
          <div class="settings-subtitle">Daten</div>
          <p class="settings-muted">
            Hier kannst du alle Kalender- und To-Do-Eintr√§ge l√∂schen.
          </p>
          <button type="button" class="settings-danger-btn" id="btnResetAll">
            Alle Daten l√∂schen
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- NAVIGATION -->
  <div class="bottom-nav">
    <div class="nav-item nav-active" data-screen="home">üè†</div>
    <div class="nav-item" data-screen="ki">ü§ñ</div>
    <div class="nav-item" data-screen="calendar">üìÖ</div>
    <div class="nav-item" data-screen="plant">üíê</div>
    <div class="nav-item" data-screen="settings">‚öôÔ∏è</div>
  </div>
</div>

<!-- Datenschutz-Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Datenschutzbestimmung</h3>
    <p>
      Deine Daten (Kalender, To-Dos, Name, Profilbild, Einstellungen) werden nur lokal in deinem Browser gespeichert
      (localStorage). Es wird nichts an einen Server gesendet.
    </p>
    <p class="settings-muted" style="margin-bottom: 12px;">
      Wenn du alle Daten entfernen m√∂chtest, nutze ‚ÄûAlle Daten l√∂schen‚Äú in den Einstellungen.
    </p>
    <div class="modal-actions">
      <button class="btn-secondary" id="modalClose">Schlie√üen</button>
    </div>
  </div>
</div>

<script>
  // --- Hilfsfunktionen ---
  function pad2(n){ return n < 10 ? "0"+n : ""+n; }
  function addDays(date, days){ const d = new Date(date); d.setDate(d.getDate()+days); return d; }
  function dateKey(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }

  const APP_YEAR = 2026;

  // Storage: events sind Objekte {text, color}
  let events = {};
  let todos = []; // {id, text, done, key?}

  // Settings + Profil
  let settings = {
    showGreeting: true,
    darkMode: false,
    profileName: "",
    profileImage: "" // base64
  };

  function normalizeEvents(){
    for(const key in events){
      if(typeof events[key] === "string"){
        events[key] = { text: events[key], color: "gelb" };
      }
    }
  }

  function loadStorage(){
    try{ events = JSON.parse(localStorage.getItem("kalenderEvents")) || {}; }catch{ events={}; }
    try{ todos  = JSON.parse(localStorage.getItem("todoItems")) || []; }catch{ todos=[]; }
    normalizeEvents();
  }
  function saveStorage(){
    localStorage.setItem("kalenderEvents", JSON.stringify(events));
    localStorage.setItem("todoItems", JSON.stringify(todos));
  }

  function loadSettings(){
    try{
      const raw = localStorage.getItem("plannerSettings");
      if(raw){
        const parsed = JSON.parse(raw);
        settings = Object.assign(settings, parsed || {});
      }
    }catch(e){}
  }
  function saveSettings(){
    localStorage.setItem("plannerSettings", JSON.stringify(settings));
  }

  function setToggleUI(toggleEl, on){
    if(!toggleEl) return;
    toggleEl.classList.toggle("toggle-on", !!on);
    toggleEl.setAttribute("aria-checked", !!on);
  }

  function applySettings(){
    // Dark mode
    document.body.classList.toggle("dark", !!settings.darkMode);

    // Home Greeting
    const g1 = document.getElementById("homeGreetingLine");
    const g2 = document.getElementById("homeWelcomeLine");
    const show = !!settings.showGreeting;
    if(g1) g1.style.display = show ? "" : "none";
    if(g2) g2.style.display = show ? "" : "none";

    // Name in Greeting
    const name = (settings.profileName || "").trim();
    if(g1){
      g1.textContent = name ? `Hallo ${name}, ich bin dein Planer üòä` : `Hallo, ich bin dein Planer üòä`;
    }

    // Profil Avatar
    const avatar = document.getElementById("profileAvatar");
    if(avatar){
      avatar.innerHTML = "";
      if(settings.profileImage){
        const img = document.createElement("img");
        img.src = settings.profileImage;
        img.alt = "Profilbild";
        avatar.appendChild(img);
      }else{
        const span = document.createElement("span");
        span.textContent = "üôÇ";
        span.style.fontWeight = "1000";
        span.style.color = "var(--text-strong)";
        avatar.appendChild(span);
      }
    }

    // Inputs in Settings
    const nameInput = document.getElementById("profileNameInput");
    if(nameInput) nameInput.value = settings.profileName || "";

    // Toggles in Settings
    setToggleUI(document.getElementById("darkToggle"), !!settings.darkMode);
    setToggleUI(document.getElementById("greetingToggle"), !!settings.showGreeting);

    // Wenn wir im Kalender sind, neu rendern (wegen Farbcodes/Theme)
    if(currentWeekStart){
      renderWeekView();
    }
  }

  // --- Blumenstrau√ü / Analyse ---
  function updatePlant(){
    const percentSpan = document.getElementById("progressPercent");
    const percentText = document.getElementById("plantPercentLabel");
    const flowers = document.querySelectorAll("#plantSvg .flower");
    if(!percentSpan || !percentText || !flowers.length) return;

    const total = todos.length;
    const done = todos.filter(t=>t.done).length;
    const percent = total ? Math.round(done/total*100) : 0;

    percentSpan.textContent = percent;
    percentText.textContent = percent + "%";

    const maxFlowers = flowers.length; // 12
    let flowersToShow = Math.round((percent / 100) * maxFlowers);
    if(percent > 0 && flowersToShow === 0) flowersToShow = 1;

    flowers.forEach((flower, index)=>{
      flower.style.opacity = index < flowersToShow ? 1 : 0;
    });
  }

  // --- ToDos ---
  function renderTodos(){
    const listOpen = document.getElementById("todoListOpen");
    const listDone = document.getElementById("todoListDone");
    if(!listOpen || !listDone) return;

    listOpen.innerHTML = "";
    listDone.innerHTML = "";

    const openTodos = todos.filter(t=>!t.done);
    const doneTodos = todos.filter(t=>t.done);

    if(openTodos.length === 0){
      const p = document.createElement("div");
      p.className = "todo-empty";
      p.textContent = "Keine offenen Aufgaben.";
      listOpen.appendChild(p);
    }

    if(doneTodos.length === 0){
      const p = document.createElement("div");
      p.className = "todo-empty";
      p.textContent = "Noch nichts erledigt.";
      listDone.appendChild(p);
    }

    openTodos.forEach(todo=>{
      const item = document.createElement("div");
      item.className = "todo-item";
      item.dataset.id = todo.id;

      const box = document.createElement("div");
      box.className = "todo-checkbox";
      box.dataset.id = todo.id;

      const span = document.createElement("span");
      span.className = "todo-text";
      span.textContent = todo.text;

      item.appendChild(box);
      item.appendChild(span);
      listOpen.appendChild(item);

      item.addEventListener("click", ()=>{ toggleTodo(todo.id); });
    });

    doneTodos.forEach(todo=>{
      const item = document.createElement("div");
      item.className = "todo-item";
      item.dataset.id = todo.id;

      const box = document.createElement("div");
      box.className = "todo-checkbox todo-checked";
      box.dataset.id = todo.id;
      box.textContent = "‚úî";

      const span = document.createElement("span");
      span.className = "todo-text todo-done";
      span.textContent = todo.text;

      item.appendChild(box);
      item.appendChild(span);
      listDone.appendChild(item);

      item.addEventListener("click", ()=>{ toggleTodo(todo.id); });
    });

    updatePlant();
  }

  function toggleTodo(id){
    const idx = todos.findIndex(t=>t.id===id);
    if(idx === -1) return;
    todos[idx].done = !todos[idx].done;
    saveStorage();
    renderTodos();
  }

  // --- KI-Parsing ---
  function parseDateFromLine(line){
    const m = line.match(/(\d{1,2})\.(\d{1,2})\./);
    if(!m) return null;
    const day = parseInt(m[1],10);
    const month = parseInt(m[2],10);
    if(isNaN(day)||isNaN(month)) return null;
    const date = new Date(APP_YEAR, month-1, day);
    return { date, raw: m[0], index: m.index, endIndex: m.index + m[0].length };
  }

  function parseLineToEvent(line){
    const original = line.trim();
    if(!original) return null;

    const dateInfo = parseDateFromLine(original);
    if(!dateInfo) return null;

    const { date, raw: rawDate, endIndex } = dateInfo;

    let hour = 9, minute = 0;
    const afterDate = original.slice(endIndex);
    const t = afterDate.match(/(\d{1,2})[:\.](\d{2})/);
    if(t){
      hour = parseInt(t[1],10);
      minute = parseInt(t[2],10);
      if(isNaN(hour)||hour<0||hour>23) hour=9;
      if(isNaN(minute)||minute<0||minute>59) minute=0;
    }

    let task = original.replace(rawDate, "").trim();
    if(t) task = task.replace(t[0], "").trim();
    task = task.replace(/\s*[-‚Äì‚Äî]\s*/g, " ").replace(/\s+/g," ").trim();
    if(!task) task = "Aufgabe";

    const key = dateKey(date)+"-"+hour;

    let eventText = task;
    if(t) eventText += " ("+pad2(hour)+":"+pad2(minute)+")";

    const todoLabel =
      `${pad2(date.getDate())}.${pad2(date.getMonth()+1)}. - ` +
      `${task} - ${pad2(hour)}:${pad2(minute)}`;

    return { key, date, hour, minute, eventText, todoLabel };
  }

  document.getElementById("sendPlan").addEventListener("click", ()=>{
    const input = document.getElementById("planInput").value;
    const lines = input.split(/\r?\n/);
    const output = document.getElementById("outputBox");
    let count = 0;
    const added = [];

    lines.forEach(line=>{
      const ev = parseLineToEvent(line);
      if(!ev) return;

      events[ev.key] = { text: ev.eventText, color: "gelb" };
      added.push(ev);
      count++;

      todos.push({
        id: Date.now() + Math.random(),
        text: ev.todoLabel,
        done: false,
        key: ev.key
      });
    });

    if(count === 0){
      output.textContent = "Ich konnte keine g√ºltigen Eintr√§ge mit Datum erkennen. Beispiel: ‚ÄûMontag 12.02. Mathe 16:00‚Äú.";
      return;
    }

    saveStorage();
    renderTodos();

    let msg = "Ich habe "+count+" Eintrag";
    if(count>1) msg += "e";
    msg += " im Kalender und in der To-Do-Liste gespeichert:\n\n";
    added.forEach(ev=>{
      msg += "- "+dateKey(ev.date)+" "+pad2(ev.hour)+":"+pad2(ev.minute)+" ‚Äì "+ev.eventText+"\n";
    });
    msg += "\nSchau dir die Termine im Kalender (üìÖ) an oder hake sie auf Home (üè†) ab.";
    output.textContent = msg;
  });

  document.getElementById("clearInput").addEventListener("click", ()=>{
    document.getElementById("planInput").value = "";
  });

  // --- Kalender ---
  const monthNames = ["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
  const weekdayShort = ["M","D","M","D","F","S","S"];

  let currentWeekStart = null;
  let currentEditKey = null;
  let currentEditCell = null;
  let editorSelectedColor = "gelb";

  function generateYearCalendar(year){
    const container = document.getElementById("calendar");
    const yearTitle = document.getElementById("yearTitle");
    yearTitle.textContent = year;
    container.innerHTML = "";

    for(let month=0; month<12; month++){
      const monthDiv = document.createElement("div");
      monthDiv.className = "month";

      const nameDiv = document.createElement("div");
      nameDiv.className = "month-name";
      nameDiv.textContent = monthNames[month];
      monthDiv.appendChild(nameDiv);

      const table = document.createElement("table");
      table.className = "month-table";

      const thead = document.createElement("thead");
      const hRow = document.createElement("tr");
      weekdayShort.forEach(d=>{
        const th = document.createElement("th");
        th.textContent = d;
        hRow.appendChild(th);
      });
      thead.appendChild(hRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      const firstDay = new Date(year, month, 1);
      const daysInMonth = new Date(year, month+1, 0).getDate();
      let startIndex = (firstDay.getDay() + 6) % 7;

      let row = document.createElement("tr");
      for(let i=0;i<startIndex;i++){
        const td = document.createElement("td");
        td.className = "empty";
        row.appendChild(td);
      }

      for(let day=1; day<=daysInMonth; day++){
        if(row.children.length === 7){
          tbody.appendChild(row);
          row = document.createElement("tr");
        }
        const td = document.createElement("td");
        td.textContent = day;
        const date = new Date(year, month, day);
        td.addEventListener("click", ()=>openDateInWeekView(date));
        row.appendChild(td);
      }

      while(row.children.length < 7){
        const td = document.createElement("td");
        td.className = "empty";
        row.appendChild(td);
      }
      tbody.appendChild(row);
      table.appendChild(tbody);
      monthDiv.appendChild(table);
      container.appendChild(monthDiv);
    }
  }

  function formatRangeTitle(startDate){
    const endDate = addDays(startDate, 6);
    const sameMonth = startDate.getMonth() === endDate.getMonth();
    const mName = monthNames[startDate.getMonth()];
    if(sameMonth){
      return `${startDate.getDate()}.‚Äì${endDate.getDate()}. ${mName} ${startDate.getFullYear()}`;
    }
    return `${pad2(startDate.getDate())}.${pad2(startDate.getMonth()+1)}. ‚Äì ${pad2(endDate.getDate())}.${pad2(endDate.getMonth()+1)}. ${endDate.getFullYear()}`;
  }

  function openDateInWeekView(date){
    const weekday = (date.getDay() + 6) % 7;
    currentWeekStart = addDays(date, -weekday);
    document.getElementById("yearView").style.display = "none";
    document.getElementById("weekView").style.display = "block";
    closeEditor();
    renderWeekView();
  }

  document.getElementById("backToYear").addEventListener("click", ()=>{
    document.getElementById("weekView").style.display = "none";
    document.getElementById("yearView").style.display = "block";
    closeEditor();
  });

  document.getElementById("prevWeek").addEventListener("click", ()=>{
    currentWeekStart = addDays(currentWeekStart, -7);
    closeEditor();
    renderWeekView();
  });

  document.getElementById("nextWeek").addEventListener("click", ()=>{
    currentWeekStart = addDays(currentWeekStart, 7);
    closeEditor();
    renderWeekView();
  });

  function applyCellColor(cell, color){
    if(!cell) return;
    cell.style.backgroundColor = "";
    const cs = getComputedStyle(document.body);
    if(color === "rot")  cell.style.backgroundColor = cs.getPropertyValue("--cal-rot").trim();
    if(color === "gelb") cell.style.backgroundColor = cs.getPropertyValue("--cal-gelb").trim();
    if(color === "blau") cell.style.backgroundColor = cs.getPropertyValue("--cal-blau").trim();
  }

  function renderWeekView(){
    const weekBody = document.getElementById("weekBody");
    const weekTitle = document.getElementById("weekTitle");
    weekBody.innerHTML = "";
    weekTitle.textContent = formatRangeTitle(currentWeekStart);

    const theadRow = document.querySelector(".week-table thead tr");
    for(let i=1;i<=7;i++){
      const th = theadRow.children[i];
      const date = addDays(currentWeekStart, i-1);
      const name = ["Mo","Di","Mi","Do","Fr","Sa","So"][i-1];
      th.innerHTML = `<span class="day-header-small">${name}</span>
                      <span class="day-header-date">${pad2(date.getDate())}.${pad2(date.getMonth()+1)}.</span>`;
    }

    for(let hour=0; hour<24; hour++){
      const row = document.createElement("tr");
      const th = document.createElement("th");
      th.textContent = pad2(hour)+":00";
      row.appendChild(th);

      for(let d=0; d<7; d++){
        const td = document.createElement("td");
        const date = addDays(currentWeekStart, d);
        const key = dateKey(date)+"-"+hour;

        const ev = events[key];
        if(ev){
          const text  = typeof ev === "string" ? ev : ev.text;
          const color = typeof ev === "string" ? "gelb" : (ev.color || "gelb");
          td.textContent = text;
          applyCellColor(td, color);
        }

        td.addEventListener("click", ()=>openEditor(key, date, hour, td));
        row.appendChild(td);
      }
      weekBody.appendChild(row);
    }
  }

  function updateColorButtonsUI(){
    document.querySelectorAll(".color-dot").forEach(btn=>{
      btn.classList.toggle("color-active", btn.dataset.color === editorSelectedColor);
    });
  }

  function openEditor(key, date, hour, cell){
    currentEditKey = key;
    currentEditCell = cell;

    const panel = document.getElementById("editorPanel");
    const info = document.getElementById("editorInfo");
    const textarea = document.getElementById("editorText");
    info.textContent = `Eintrag f√ºr ${dateKey(date)} ${pad2(hour)}:00`;

    const ev = events[key];
    if(ev){
      const text  = typeof ev === "string" ? ev : ev.text;
      const color = typeof ev === "string" ? "gelb" : (ev.color || "gelb");
      textarea.value = text;
      editorSelectedColor = color;
    }else{
      textarea.value = "";
      editorSelectedColor = "gelb";
    }
    updateColorButtonsUI();
    panel.style.display = "flex";
  }

  function closeEditor(){
    currentEditKey = null;
    currentEditCell = null;
    document.getElementById("editorPanel").style.display = "none";
  }

  document.getElementById("saveEntry").addEventListener("click", ()=>{
    if(!currentEditKey || !currentEditCell) return;
    const text = document.getElementById("editorText").value.trim();

    if(text === ""){
      delete events[currentEditKey];
      currentEditCell.textContent = "";
      applyCellColor(currentEditCell, null);
      todos = todos.filter(t => t.key !== currentEditKey);
      saveStorage();
      renderTodos();
      closeEditor();
      return;
    }

    events[currentEditKey] = { text: text, color: editorSelectedColor || "gelb" };
    currentEditCell.textContent = text;
    applyCellColor(currentEditCell, editorSelectedColor);
    saveStorage();
    closeEditor();
  });

  document.getElementById("deleteEntry").addEventListener("click", ()=>{
    if(!currentEditKey || !currentEditCell) return;
    delete events[currentEditKey];
    currentEditCell.textContent = "";
    applyCellColor(currentEditCell, null);
    todos = todos.filter(t => t.key !== currentEditKey);
    saveStorage();
    renderTodos();
    closeEditor();
  });

  document.getElementById("cancelEdit").addEventListener("click", closeEditor);

  document.querySelectorAll(".color-dot").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      editorSelectedColor = btn.dataset.color;
      updateColorButtonsUI();
    });
  });

  // --- Datenschutz Modal ---
  const modalBackdrop = document.getElementById("modalBackdrop");
  function openModal(){ modalBackdrop.style.display = "flex"; }
  function closeModal(){ modalBackdrop.style.display = "none"; }

  document.getElementById("btnPrivacy").addEventListener("click", openModal);
  document.getElementById("modalClose").addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e)=>{
    if(e.target === modalBackdrop) closeModal();
  });

  // --- Toggles (Dark/Greeting) ---
  function setToggleUI(toggleEl, on){
    if(!toggleEl) return;
    toggleEl.classList.toggle("toggle-on", !!on);
    toggleEl.setAttribute("aria-checked", !!on);
  }

  function bindToggle(toggleEl, getter, setter){
    if(!toggleEl) return;

    const toggleAction = ()=>{
      const next = !getter();
      setter(next);
      saveSettings();
      applySettings();
    };

    toggleEl.addEventListener("click", toggleAction);
    toggleEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggleAction();
      }
    });
  }

  bindToggle(
    document.getElementById("darkToggle"),
    ()=>!!settings.darkMode,
    (v)=>{ settings.darkMode = !!v; }
  );

  bindToggle(
    document.getElementById("greetingToggle"),
    ()=>!!settings.showGreeting,
    (v)=>{ settings.showGreeting = !!v; }
  );

  // --- Profil Name ---
  const profileNameInput = document.getElementById("profileNameInput");
  if(profileNameInput){
    profileNameInput.addEventListener("input", ()=>{
      settings.profileName = profileNameInput.value;
      saveSettings();
      applySettings();
    });
  }

  // --- Profil Bild Upload ---
  const profileImageInput = document.getElementById("profileImageInput");
  if(profileImageInput){
    profileImageInput.addEventListener("change", ()=>{
      const file = profileImageInput.files && profileImageInput.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = ()=>{
        settings.profileImage = reader.result;
        saveSettings();
        applySettings();
      };
      reader.readAsDataURL(file);
    });
  }

  // --- Reset ---
  const resetBtn = document.getElementById("btnResetAll");
  if(resetBtn){
    resetBtn.addEventListener("click", ()=>{
      if(!confirm("Willst du wirklich alle Kalender- und To-Do-Eintr√§ge l√∂schen?")) return;
      events = {};
      todos = [];
      saveStorage();

      localStorage.removeItem("plannerSettings");
      settings = { showGreeting: true, darkMode: false, profileName: "", profileImage: "" };
      saveSettings();

      renderTodos();
      updatePlant();
      if(currentWeekStart) renderWeekView();
      applySettings();

      alert("Alle Daten wurden gel√∂scht.");
    });
  }

  // --- Navigation ---
  const navItems = document.querySelectorAll(".nav-item");
  function setActiveScreen(screen){
    document.getElementById("screenHome").classList.remove("screen-active");
    document.getElementById("screenKI").classList.remove("screen-active");
    document.getElementById("screenCalendar").classList.remove("screen-active");
    document.getElementById("screenPlant").classList.remove("screen-active");
    document.getElementById("screenSettings").classList.remove("screen-active");

    if(screen==="home") document.getElementById("screenHome").classList.add("screen-active");
    if(screen==="ki") document.getElementById("screenKI").classList.add("screen-active");
    if(screen==="calendar") document.getElementById("screenCalendar").classList.add("screen-active");
    if(screen==="plant") document.getElementById("screenPlant").classList.add("screen-active");
    if(screen==="settings") document.getElementById("screenSettings").classList.add("screen-active");

    navItems.forEach(i=>i.classList.remove("nav-active"));
    navItems.forEach(i=>{ if(i.dataset.screen===screen) i.classList.add("nav-active"); });

    if(screen==="plant") updatePlant();
  }

  navItems.forEach(item=>{
    item.addEventListener("click", ()=>{
      const s = item.dataset.screen;
      if(!s) return;
      setActiveScreen(s);
    });
  });
 <script>
(function () {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isStandalone =
    window.navigator.standalone === true ||
    window.matchMedia("(display-mode: standalone)").matches;

  if (!(isIOS && isStandalone)) return;

  function focusClosest(e) {
    const el = e.target.closest("input, textarea, select, [contenteditable='true']");
    if (!el) return;
    el.focus({ preventScroll: false }); // synchron = Tastatur √∂ffnet sich
  }

  document.addEventListener("touchstart", focusClosest, true);
  document.addEventListener("pointerdown", focusClosest, true);
  document.addEventListener("click", focusClosest, true);
})();
</script>


  // --- Start ---
  loadStorage();
  loadSettings();
  generateYearCalendar(APP_YEAR);
  renderTodos();
  applySettings();
  updatePlant();
</script>
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
  }
</script>
</body>
</html>










